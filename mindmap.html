<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        .floatTL {
            position: absolute;
            top: 0px;
            left: 0px;
        }

        #mindmap {
            overflow: scroll;
            width: max-content;
            height: max-content;
            z-index: 999;
        }

        .hierarchy {
            border: 0px;
            margin-bottom: 20px;
            margin-top: 20px;
            text-align: center;
            height: max-content;
        }

        .node_wrapper {
            border: 0;
            float: left;
            display: inline-block;
            padding: 10px;
            margin-right: 10px;
            margin-left: 10px;
        }

        .node {
            border: 1px solid #000;
            display: inline-block;
            padding: 10px;
            margin-right: 10px;
            margin-left: 10px;
            text-align: left;
        }

        .complete {
            background-image: linear-gradient(135deg, #c2bebf 4.55%, #ffffff 4.55%, #ffffff 50%, #c2bebf 50%, #c2bebf 54.55%, #ffffff 54.55%, #ffffff 100%);
            background-size: 15.56px 15.56px;
        }

        .circle {
            border-radius: 100%;
            background: #ffffff;
            display: inline-block;
            line-height: 100%;
        }

        progress {
            width: 100%;
        }

        body {
            font-size: small;
        }

        input[type=text] {
            width: 300px;
        }

    </style>

</head>
<body>


<div id="mindmap" class="floatTL">
</div>

<div class="floatTL">
    <svg>
    </svg>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    let mindmap = {}


    let id = 0;

    function resetId(data) {

        if (data.tasks) {
            data.tasks.forEach((task, idx) => task.id = `node-${id}-task-${idx}`)
        }

        let nodeId = `node-${id++}`;
        data.id = nodeId;

        if (data.children) {
            for (const child of data.children) {
                child.parentId = nodeId;
                resetId(child);
            }
        }

    }

    function resetProgress(totalTasksNum, doneTasksNum, data) {
        let ttn = totalTasksNum;
        let dtn = doneTasksNum;

        if (data.children) {
            let t = 0;
            let d = 0;
            for (const child of data.children) {
                let {ttn, dtn} = resetProgress(totalTasksNum, doneTasksNum, child)
                t += ttn;
                d += dtn;
            }
            ttn += t;
            dtn += d;
        }

        if (data.tasks) {
            ttn += data.tasks.length;
            dtn += data.tasks.filter(task => task.checked).length
        }

        data.totalTasksNum = ttn;
        data.doneTasksNum = dtn;

        return {ttn, dtn}
    }

    function drawDiv(parent, data) {
        let nodeTemplate = `
<div class="node_wrapper" id="${data.id}">
    <div class="node ${(data.totalTasksNum !== 0 && data.doneTasksNum === data.totalTasksNum) ? 'complete' : ''}"
        style="${data.color ? "border:2px solid " + data.color + ";" : ""}"
    >
        제목 : <input type="text" name="title" value="${data.text || ''}" data-node-id="${data.id}" data-parent-node-id="${data.parentId}"/>
        <br/>
        ISSUE : <input type="text" name="issue" value="${data.issue || ''}" data-node-id="${data.id}" data-parent-node-id="${data.parentId}"/>
        <button class="circle" data-node-id="${data.id}" data-parent-node-id="${data.parentId}"  name="link_issue">go</button>
        <br/>
        담당자 : <input type="text" name="author" value="${data.author || ''}" data-node-id="${data.id}" data-parent-node-id="${data.parentId}"/>
        <br/>
        D-Day : <input type="date" value="${data.dDay || ''}" data-node-id="${data.id}" data-parent-node-id="${data.parentId}"/>
        <br/>
        <button class="circle" data-node-id="${data.id}" data-parent-node-id="${data.parentId}" name="add_child">c</button>
        <button class="circle" data-node-id="${data.id}" data-parent-node-id="${data.parentId}" name="add_sibling">s</button>
        <button class="circle" data-node-id="${data.id}" data-parent-node-id="${data.parentId}" name="add_task">t</button>
        <button class="circle" data-node-id="${data.id}" data-parent-node-id="${data.parentId}" name="remove_node">r</button>
        <input type="color" value="${data.color}" data-node-id="${data.id}" data-parent-node-id="${data.parentId}">
        <br/>
        ${data.doneTasksNum || 0} / ${data.totalTasksNum || 0}
        <br/>
        <progress id="${data.id}-progress" max="100" value="${(data.doneTasksNum / data.totalTasksNum) * 100}"/>
    </div>
</div>
`
        let node = $(nodeTemplate)


        if (data.tasks) {
            let tasks = data.tasks.map(child => $(`
<br/>
    <input type="checkbox" ${child.checked ? "checked" : ""} name="task-status" id="${child.id}" data-node-id="${data.id}" data-task-id="${child.id}"/>
    <label for="${child.id}"><input type="text" name="task" value="${child.text || ''}" data-node-id="${data.id}" data-task-id="${child.id}"/></label>
    &nbsp;<button class="circle" data-node-id="${data.id}" data-task-id="${child.id}" name="remove_task">r</button>
`
            ));
            node.find(".node").append(tasks)
        }

        if (data.children) {
            let hierarchyTemplate = `<div class='hierarchy'/>`
            let rootDiv = $(hierarchyTemplate);
            data.children.forEach(child => drawDiv(rootDiv, child));
            node.append(rootDiv);
        }


        parent.append(node);
    }

    function drawSvg(root, data) {

        if (data.children) {
            let $parent = $("#" + data.id).find(".hierarchy").first();
            let {top, left} = $parent.position();
            let width = $parent.width();

            let parentBottomCenter = {"top": top, "left": left + (width / 2)}

            for (const child of data.children) {
                let $child = $("#" + child.id).find(".node");
                let {top, left} = $child.position();
                let width = $child.width();

                let childTopCenter = {"top": top, "left": left + (width / 2)}

                let newLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                newLine.setAttribute("x1", parentBottomCenter.left);
                newLine.setAttribute("y1", parentBottomCenter.top);
                newLine.setAttribute("x2", childTopCenter.left);
                newLine.setAttribute("y2", childTopCenter.top);
                newLine.setAttribute("style", "stroke:rgb(0,0,0);stroke-width:1");

                root.appendChild(newLine);
                drawSvg(root, child);
            }
        }
    }

    function drawMindmap() {
        // let data = {
        //     "text": "parent",
        //     "color": "#bdf",
        //     "children": [
        //         {
        //             "text": "child1",
        //             "tasks": [
        //                 {text: "1. 이거 하기", checked: true},
        //             ],
        //             "children": [
        //                 {
        //                     "text": "child1"
        //
        //                 },
        //                 {
        //                     "text": "child2"
        //                 }
        //             ]
        //         },
        //         {
        //             "text": "child2",
        //             "tasks": [
        //                 {text: "1. 이거 하기"},
        //                 {text: "2. 저거 하기"}
        //             ],
        //             "children": [
        //                 {
        //                     "text": "child1",
        //                     "tasks": [
        //                         {text: "1. 이거 하기"},
        //                         {text: "2. 저거 하기", checked: true}
        //                     ],
        //                 },
        //                 {
        //                     "text": "child2"
        //                 }
        //             ]
        //         },
        //         {
        //             "text": "child1",
        //             "tasks": [
        //                 {text: "1. 이거 하기", checked: true},
        //             ],
        //             "children": [
        //                 {
        //                     "text": "child1"
        //
        //                 },
        //                 {
        //                     "text": "child2"
        //                 }
        //             ]
        //         },
        //         {
        //             "text": "child1",
        //             "tasks": [
        //                 {text: "1. 이거 하기", checked: true},
        //             ],
        //             "children": [
        //                 {
        //                     "text": "child1"
        //
        //                 },
        //                 {
        //                     "text": "child2"
        //                 }
        //             ]
        //         },
        //     ]
        // }

        $("#mindmap").empty();
        $("svg").empty();


        id = 0;
        resetId(mindmap);
        resetProgress(0, 0, mindmap);

        let rootDiv = $(`<div class='hierarchy'/>`);
        drawDiv(rootDiv, mindmap);
        $("#mindmap").append(rootDiv);


        $("svg").attr({
            width: $("#mindmap").width(),
            height: $("#mindmap").height()
        });
        drawSvg(document.querySelector("svg"), mindmap);

    }

    drawMindmap();

    $(document).ready(() => {
        $(document).on("click", "button[name=add_task]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.tasks = node.tasks || [];
            node.tasks.push({})

            drawMindmap();

        });

        $(document).on("click", "button[name=remove_task]", (e) => {
            e.preventDefault();

            let taskId = $(e.target).data("taskId");

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.tasks = node.tasks.filter(task => (task.id) !== taskId);

            drawMindmap();

        });

        $(document).on("click", "button[name=add_child]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.children = node.children || [];
            node.children.push({})

            drawMindmap();

        });


        $(document).on("click", "button[name=add_sibling]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);
            if(isRootNode(node)) {
                return;
            }

            let parentNodeId = $(e.target).data("parentNodeId");
            let parentNode = getNode(parentNodeId, mindmap);

            parentNode.children = parentNode.children || [];
            parentNode.children.push({})

            drawMindmap();

        });

        $(document).on("click", "button[name=remove_node]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);
            if(isRootNode(node)) {
                return;
            }

            let parentNodeId = $(e.target).data("parentNodeId");
            let parentNode = getNode(parentNodeId, mindmap);

            parentNode.children = parentNode.children.filter(t => t.id !== nodeId);

            drawMindmap();

        })

        $(document).on("click", "button[name=link_issue]", e => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            if (node.issue) {
                window.open(node.issue)
            } else {
                alert("이슈를 등록해주세요.")
            }

        })

        $(document).on("change", "input[type=text][name=title]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.title = $(e.target).val();

        });

        $(document).on("change", "input[type=text][name=author]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.author = $(e.target).val();

        })


        $(document).on("change", "input[type=text][name=issue]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.issue = $(e.target).val();

        })

        $(document).on("change", "input[type=text][name=task]", (e) => {
            e.preventDefault();

            let taskId = $(e.target).data("taskId");
            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            for (const task of node.tasks) {
                if (task.id === taskId) {
                    task.text = $(e.target).val();
                }
            }
        })


        $(document).on("keyup", "input[type=text][name=task]", (e) => {
            e.preventDefault();

            if (e.key === 'Enter') {
                let taskId = $(e.target).data("taskId");
                let nodeId = $(e.target).data("nodeId");
                let node = getNode(nodeId, mindmap);

                let idx = node.tasks.findIndex((task) => task.id === taskId);
                if (idx === node.tasks.length - 1) { // 마지막
                    node.tasks = node.tasks || [];
                    node.tasks.push({})

                    drawMindmap();

                    node = getNode(nodeId, mindmap);
                }

                $(`input[type=text][data-task-id=${node.tasks[idx + 1].id}]`).focus();

            }
        })

        $(document).on("change", "input[type=checkbox][name=task-status]", (e) => {

            let taskId = $(e.target).data("taskId");
            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            for (const task of node.tasks) {
                if (task.id === taskId) {
                    task.checked = $(e.target).is(":checked")
                }
            }

            drawMindmap();
        })

        $(document).on("change", "input[type=color]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.color = $(e.target).val();

            drawMindmap();
        })


        $(document).on("change", "input[type=date]", (e) => {
            e.preventDefault();

            let nodeId = $(e.target).data("nodeId");
            let node = getNode(nodeId, mindmap);

            node.dDay = $(e.target).val();

            drawMindmap();
        })
    })

    function getNode(id, data) {
        if (data.id === id) {
            return data;
        }

        if (data.children) {
            for (const child of data.children) {
                let childResult = getNode(id, child);

                if (childResult) {
                    return childResult;
                }
            }
        }
    }

    function isRootNode(node) {
        return node.id === 'node-0';
    }


</script>

</body>
</html>